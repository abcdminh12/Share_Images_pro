<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Master - Auto Sync</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #6c5ce7;
        --primary-gradient: linear-gradient(135deg, #6c5ce7, #a29bfe);
        --bg-overlay: rgba(255, 255, 255, 0.65);
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.4);
        --text-color: #2d3436;
        --text-secondary: #636e72;
        --input-bg: rgba(255, 255, 255, 0.9);
        --shadow-color: rgba(0, 0, 0, 0.1);
        --success-color: #00b894;
        --danger-color: #ff7675;
        --warning-color: #fdcb6e;
        --border-radius: 16px;
        --transition-speed: 0.4s;
        --bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      [data-theme="dark"] {
        --primary-color: #a29bfe;
        --primary-gradient: linear-gradient(135deg, #6c5ce7, #4834d4);
        --bg-overlay: rgba(0, 0, 0, 0.6);
        --glass-bg: rgba(30, 30, 30, 0.65);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-color: #dfe6e9;
        --text-secondary: #b2bec3;
        --input-bg: rgba(0, 0, 0, 0.3);
        --shadow-color: rgba(0, 0, 0, 0.4);
      }

      * {
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
      }

      body {
        font-family: "Outfit", sans-serif;
        margin: 0;
        min-height: 100vh;
        color: var(--text-color);
        background: url("https://anhdepbonphuong.com/wp-content/uploads/2015/12/hinh-nen-noel-may-tinh-5.jpg")
          no-repeat center center fixed;
        background-size: cover;
        position: relative;
        transition: color var(--transition-speed);
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: absolute;
        inset: 0;
        background: var(--bg-overlay);
        backdrop-filter: blur(8px);
        z-index: -1;
        transition: background var(--transition-speed);
      }

      #snow-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }

      .snowflake {
        position: fixed;
        top: -10px;
        background: white;
        border-radius: 50%;
        pointer-events: none;
        z-index: 0;
        filter: blur(1px);
        animation: fall linear infinite, sway ease-in-out infinite;
      }

      @keyframes fall {
        to {
          transform: translateY(110vh);
        }
      }

      @keyframes sway {
        0%,
        100% {
          margin-left: 0;
        }
        50% {
          margin-left: 50px;
        }
      }

      .view-section {
        animation: slideInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .stat-card,
      .history-card,
      .result-item {
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .stat-card:hover {
        transform: translateY(-10px) scale(1.03);
        box-shadow: 0 15px 45px var(--shadow-color);
        background: var(--glass-bg);
      }

      .btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s var(--bounce);
      }

      .btn:active {
        transform: scale(0.95);
      }

      .modal-content {
        animation: modalPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes modalPop {
        from {
          opacity: 0;
          transform: scale(0.5) translateY(100px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .url-input:focus {
        width: 105%;
        border-color: var(--primary-color);
        background: white;
      }

      .container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
        position: relative;
        z-index: 1;
      }

      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: var(--glass-bg);
        padding: 15px 25px;
        border-radius: var(--border-radius);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px 0 var(--shadow-color);
        backdrop-filter: blur(12px);
        flex-wrap: wrap;
        gap: 15px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      h2.title {
        margin: 0;
        font-weight: 700;
        font-size: 24px;
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .server-select {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--glass-border);
        background: var(--input-bg);
        color: var(--primary-color);
        font-weight: 600;
        font-family: inherit;
        font-size: 14px;
        outline: none;
        cursor: pointer;
        transition: 0.3s;
        min-width: 150px;
      }
      .server-select:hover {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.1);
      }

      .btn-group {
        display: flex;
        gap: 10px;
      }
      .btn {
        border: none;
        padding: 10px 18px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s var(--bounce);
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: inherit;
        font-size: 14px;
      }
      .btn-icon-only {
        padding: 10px;
        width: 40px;
        height: 40px;
        justify-content: center;
        font-size: 18px;
      }
      .btn-theme {
        background: var(--input-bg);
        color: var(--text-color);
        border: 1px solid var(--glass-border);
      }
      .btn-theme:hover {
        background: var(--primary-color);
        color: white;
        transform: rotate(15deg);
      }
      .btn-clear {
        background: rgba(255, 118, 117, 0.15);
        color: var(--danger-color);
      }
      .btn-clear:hover {
        background: var(--danger-color);
        color: white;
        transform: translateY(-2px);
      }
      .btn-sm {
        padding: 6px 14px;
        font-size: 12px;
        height: auto;
      }

      .btn-warehouse {
        background: linear-gradient(135deg, #fd79a8, #e84393);
        color: white;
        border: none;
      }
      .btn-warehouse:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(232, 67, 147, 0.4);
        color: white;
      }

      .btn-export {
        background: rgba(9, 132, 227, 0.15);
        color: #0984e3;
      }
      .btn-export:hover {
        background: #0984e3;
        color: white;
        transform: translateY(-2px);
      }

      .btn-admin {
        background: rgba(45, 52, 54, 0.1);
        color: var(--text-color);
      }
      .btn-admin:hover {
        background: var(--text-color);
        color: var(--input-bg);
      }

      .stats-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        padding: 20px;
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: 0.3s var(--bounce);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
      }
      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }
      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-color);
      }
      .stat-label {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        margin-top: 2px;
      }

      .storage-bar-bg {
        width: 100%;
        height: 6px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin-top: 8px;
        overflow: hidden;
      }
      .storage-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #0984e3, #74b9ff);
        width: 0%;
        transition: width 1s ease;
        border-radius: 10px;
      }
      .storage-text {
        font-size: 11px;
        margin-top: 4px;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        font-weight: 600;
      }
      .refresh-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 14px;
        margin-left: 8px;
        transition: 0.3s;
      }
      .refresh-btn:hover {
        color: var(--primary-color);
        transform: rotate(180deg);
      }

      .stat-upload .stat-icon {
        background: linear-gradient(135deg, #00b894, #00cec9);
      }
      .stat-drive .stat-icon {
        background: linear-gradient(135deg, #0984e3, #74b9ff);
      }

      .url-upload-section {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius);
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px var(--shadow-color);
      }
      .url-input {
        flex-grow: 1;
        padding: 10px 15px;
        border-radius: 10px;
        border: 1px solid var(--glass-border);
        background: var(--input-bg);
        color: var(--text-color);
        font-family: inherit;
        outline: none;
        transition: 0.3s;
      }
      .url-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
      }
      .btn-url-upload {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.3s;
        white-space: nowrap;
      }
      .btn-url-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
      }

      .upload-box {
        background: var(--glass-bg);
        border: 2px dashed var(--primary-color);
        border-radius: var(--border-radius);
        padding: 50px;
        text-align: center;
        cursor: pointer;
        transition: all 0.4s var(--bounce);
        margin-bottom: 40px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px 0 var(--shadow-color);
        position: relative;
      }
      .upload-box:hover {
        transform: translateY(-5px) scale(1.01);
        border-color: #6c5ce7;
      }
      .upload-box i {
        color: var(--primary-color);
        margin-bottom: 20px;
        transition: 0.4s;
      }
      .upload-box:hover i {
        transform: translateY(-10px) scale(1.1);
      }
      .upload-box h3 {
        color: var(--text-color);
        margin: 10px 0;
      }
      .upload-box p {
        color: var(--text-secondary);
      }

      .paste-hint {
        margin-top: 15px;
        font-size: 13px;
        background: rgba(108, 92, 231, 0.1);
        color: var(--primary-color);
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 600;
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--glass-border);
        color: var(--text-secondary);
        font-weight: 600;
      }

      .result-item {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius);
        padding: 20px;
        display: flex;
        gap: 25px;
        margin-bottom: 25px;
        transition: all 0.4s var(--bounce);
        animation: slideUp 0.6s var(--bounce);
        backdrop-filter: blur(10px);
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .history-section-title {
        margin: 0 0 20px;
        font-size: 24px;
        font-weight: 700;
        color: var(--text-color);
        border-bottom: 2px solid var(--glass-border);
        padding-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .history-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 20px;
        margin-bottom: 50px;
      }
      .history-card {
        aspect-ratio: 1/1;
        background: var(--glass-bg);
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        overflow: hidden;
        cursor: pointer;
        position: relative;
        transition: 0.3s var(--bounce);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      .history-card:hover {
        transform: translateY(-5px) scale(1.05);
        border-color: var(--primary-color);
        box-shadow: 0 10px 20px rgba(108, 92, 231, 0.2);
        z-index: 2;
      }
      .history-thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: 0.3s;
      }
      .history-type-icon {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(5px);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      .modal-content {
        background: var(--glass-bg);
        width: 100%;
        max-width: 650px;
        border-radius: 20px;
        padding: 25px;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 20px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: zoomIn 0.3s var(--bounce);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes zoomIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .btn-close-modal {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 118, 117, 0.2);
        color: var(--danger-color);
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        transition: 0.3s;
        z-index: 10;
      }
      .btn-close-modal:hover {
        background: var(--danger-color);
        color: white;
        transform: rotate(90deg);
      }
      .modal-preview-box {
        width: 100%;
        max-height: 350px;
        background: #000;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .modal-img-preview {
        max-width: 100%;
        max-height: 350px;
        object-fit: contain;
      }

      .thumb-col {
        width: 150px;
        flex-shrink: 0;
      }
      .thumb-img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid var(--glass-border);
      }
      .file-icon {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: var(--text-secondary);
        background: rgba(0, 0, 0, 0.05);
      }

      .video-placeholder {
        width: 150px;
        height: 150px;
        position: relative;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .video-thumb-bg {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.6;
        transition: 0.3s;
      }
      .video-placeholder:hover .video-thumb-bg {
        transform: scale(1.1);
        opacity: 0.4;
      }
      .play-btn-overlay {
        position: absolute;
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(4px);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        transition: 0.3s;
      }
      .play-btn-overlay i {
        color: white;
        font-size: 20px;
        margin-left: 4px;
      }
      .video-placeholder:hover .play-btn-overlay {
        transform: scale(1.2);
        background: var(--primary-color);
        border-color: var(--primary-color);
      }

      .video-controls {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .btn-play {
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        color: white;
        transition: all 0.3s var(--bounce);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-transform: uppercase;
        width: 100%;
        font-family: inherit;
      }
      .btn-play:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      }
      .btn-google {
        background: linear-gradient(135deg, #4285f4, #3b5998);
      }
      .btn-html5 {
        background: linear-gradient(135deg, #ff512f, #dd2476);
      }

      .audio-icon-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        border-radius: 12px;
        color: white;
        border: 2px solid var(--glass-border);
      }

      .links-col {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
        justify-content: center;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .input-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        font-weight: 700;
      }
      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }
      .link-input {
        width: 100%;
        padding: 12px 55px 12px 15px;
        border: 1px solid transparent;
        border-radius: 10px;
        font-size: 13px;
        color: var(--primary-color);
        background: var(--input-bg);
        font-family: "Monaco", monospace;
      }
      .link-input:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        border-color: var(--primary-color);
      }
      .btn-copy {
        position: absolute;
        right: 5px;
        top: 5px;
        bottom: 5px;
        width: 40px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn-copy:hover {
        transform: scale(1.1);
      }

      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        color: var(--text-color);
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 15px;
        border-left: 5px solid;
        animation: slideLeft 0.4s var(--bounce) forwards;
        font-weight: 500;
      }
      .toast.success {
        border-color: var(--success-color);
      }
      .toast.success i {
        color: var(--success-color);
      }
      .toast.error {
        border-color: var(--danger-color);
      }
      .toast.error i {
        color: var(--danger-color);
      }
      @keyframes slideLeft {
        from {
          transform: translateX(120%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .loading-overlay {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
      }
      .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .view-section {
        transition: opacity 0.3s ease;
      }
      .hidden {
        display: none !important;
      }

      .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        margin-top: 20px;
      }
      .admin-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        backdrop-filter: blur(10px);
        transition: 0.3s;
      }
      .admin-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
      }
      .admin-card h3 {
        margin: 0 0 15px;
        font-size: 18px;
        color: var(--primary-color);
      }
      .admin-stat-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .admin-manager-box {
        margin-top: 30px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        backdrop-filter: blur(10px);
      }
      .admin-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--glass-border);
      }
      .btn-scan {
        background: var(--warning-color);
        color: #2d3436;
      }
      .btn-delete-all {
        background: var(--danger-color);
        color: white;
      }
      .admin-table-container {
        overflow-x: auto;
      }
      table.admin-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      table.admin-table th,
      table.admin-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--glass-border);
      }
      table.admin-table th {
        font-weight: 700;
        color: var(--primary-color);
        text-transform: uppercase;
        font-size: 12px;
      }
      table.admin-table tr:hover td {
        background: rgba(255, 255, 255, 0.1);
      }
      .duplicate-row {
        background-color: rgba(253, 203, 110, 0.2);
      }
      .duplicate-row:hover td {
        background-color: rgba(253, 203, 110, 0.3);
      }
      .dup-badge {
        font-size: 10px;
        background: var(--danger-color);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
      }
      .admin-file-link {
        text-decoration: none;
        color: var(--primary-color);
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .admin-file-link:hover {
        text-decoration: underline;
      }

      .custom-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary-color);
      }
      .bulk-actions {
        display: none;
        align-items: center;
        gap: 10px;
        background: rgba(255, 118, 117, 0.15);
        padding: 8px 15px;
        border-radius: 8px;
        border: 1px solid var(--danger-color);
        margin-left: 15px;
        animation: fadeIn 0.3s ease;
      }
      .bulk-text {
        font-weight: 700;
        color: var(--danger-color);
        font-size: 14px;
      }

      @media (max-width: 600px) {
        .result-item {
          flex-direction: column;
        }
        .thumb-col,
        .thumb-img,
        .file-icon,
        .video-placeholder,
        .audio-icon-box {
          width: 100%;
          height: 200px;
        }
        .stats-row {
          grid-template-columns: 1fr;
        }
        .header-actions {
          flex-direction: column;
          gap: 15px;
          align-items: stretch;
          text-align: center;
        }
        .header-left {
          flex-direction: column;
        }
        .btn-group {
          justify-content: center;
          flex-wrap: wrap;
        }
        .url-upload-section {
          flex-direction: column;
        }
        .btn-url-upload {
          width: 100%;
        }
      }
      .view-section {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .btn:disabled {
        cursor: not-allowed;
        filter: grayscale(1);
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <div id="snow-container"></div>
    <div id="toast-container"></div>

    <div class="modal-overlay" id="adminPassModal">
      <div class="modal-content" style="max-width: 400px; text-align: center">
        <button class="btn-close-modal" onclick="closeAdminModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <h3 style="color: var(--primary-color)">Yêu cầu quyền Admin</h3>
        <p>Vui lòng nhập mật khẩu quản trị viên để tiếp tục.</p>
        <input
          type="password"
          id="adminPassInput"
          class="url-input"
          placeholder="Nhập mật khẩu..."
          style="text-align: center"
        />
        <button
          class="btn btn-warehouse"
          style="justify-content: center"
          onclick="verifyAdmin()"
        >
          <i class="fa-solid fa-right-to-bracket"></i> Đăng nhập
        </button>
      </div>
    </div>

    <div class="modal-overlay" id="linkModal">
      <div class="modal-content">
        <button class="btn-close-modal" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <h3
          style="margin: 0; text-align: center; color: var(--primary-color)"
          id="modalTitle"
        >
          Chi tiết File
        </h3>
        <div class="modal-preview-box" id="modalPreview"></div>
        <div class="links-col" id="modalLinks"></div>
      </div>
    </div>

    <div class="modal-overlay" id="adminPreviewModal">
      <div class="modal-content" style="max-width: 800px; text-align: center">
        <button class="btn-close-modal" onclick="closeAdminPreview()">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <h3
          id="adminPreviewTitle"
          style="
            color: var(--primary-color);
            word-break: break-all;
            margin-bottom: 20px;
          "
        ></h3>

        <div
          id="adminPreviewContent"
          class="modal-preview-box"
          style="background: transparent; height: auto; min-height: 200px"
        ></div>

        <div
          id="adminPreviewFooter"
          style="
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: center;
            gap: 15px;
          "
        >
          <button
            id="btnDeleteInModal"
            class="btn btn-danger"
            style="padding: 12px 25px"
          >
            <i class="fa-solid fa-trash-can"></i> Xóa File Này
          </button>
          <button class="btn btn-theme" onclick="closeAdminPreview()">
            Đóng
          </button>
        </div>

        <div style="margin-top: 15px">
          <p style="font-size: 12px; color: var(--text-secondary)">
            <i class="fa-solid fa-circle-exclamation"></i> Hành động xóa sẽ xóa
            vĩnh viễn file trên Google Drive.
          </p>
        </div>
      </div>
    </div>

    <div class="loading-overlay" id="loadingBox">
      <div class="spinner"></div>
      <p style="font-weight: 600; font-size: 18px; letter-spacing: 1px">
        ĐANG TẢI LÊN...
      </p>
    </div>

    <div class="container">
      <div class="header-actions">
        <div class="header-left">
          <h2 class="title">
            Minh's Upload
            <span
              style="
                font-size: 12px;
                vertical-align: super;
                background: #6c5ce7;
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
              "
              >VIP</span
            >
          </h2>
          <select
            id="serverSelect"
            class="server-select"
            onchange="changeServer()"
          >
            <option value="0">Loading...</option>
          </select>
        </div>

        <div class="btn-group">
          <button
            class="btn btn-admin btn-icon-only"
            onclick="openAdminModal()"
            title="Admin Mode"
          >
            <i class="fa-solid fa-user-shield"></i>
          </button>

          <button
            class="btn btn-warehouse"
            onclick="switchView('gallery')"
            title="Mở kho lưu trữ"
          >
            <i class="fa-solid fa-box-archive"></i> Kho lưu trữ
          </button>

          <button
            class="btn btn-export"
            onclick="exportHistory()"
            title="Lưu lịch sử về máy"
          >
            <i class="fa-solid fa-file-export"></i> Backup
          </button>

          <button
            class="btn btn-theme btn-icon-only"
            onclick="toggleTheme()"
            title="Chế độ Sáng/Tối"
          >
            <i class="fa-solid fa-moon" id="theme-icon"></i>
          </button>
        </div>
      </div>

      <div id="view-upload" class="view-section">
        <div class="stats-row">
          <div class="stat-card stat-upload">
            <div class="stat-icon">
              <i class="fa-solid fa-cloud-arrow-up"></i>
            </div>
            <div class="stat-info">
              <span class="stat-value" id="count-uploaded">0</span>
              <span class="stat-label">Tổng file đã Upload</span>
            </div>
          </div>

          <div class="stat-card stat-drive">
            <div class="stat-icon">
              <i class="fa-brands fa-google-drive"></i>
            </div>
            <div class="stat-info">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                "
              >
                <span class="stat-value" id="count-drive">...</span>
                <button
                  class="refresh-btn"
                  onclick="loadStats(true)"
                  title="Cập nhật"
                >
                  <i class="fa-solid fa-arrows-rotate"></i>
                </button>
              </div>
              <span class="stat-label">File trên Server này</span>

              <div class="storage-bar-bg">
                <div class="storage-bar-fill" id="storage-bar"></div>
              </div>
              <div class="storage-text">
                <span id="storage-used">0 GB</span>
                <span id="storage-total">15 GB</span>
              </div>
            </div>
          </div>
        </div>

        <div class="url-upload-section">
          <i
            class="fa-solid fa-link"
            style="color: var(--primary-color); font-size: 18px"
          ></i>
          <input
            type="text"
            class="url-input"
            id="urlInput"
            placeholder="Dán link ảnh (URL) vào đây để upload trực tiếp..."
          />
          <button class="btn-url-upload" onclick="uploadFromUrl()">
            <i class="fa-solid fa-cloud-arrow-up"></i> Upload URL
          </button>
        </div>

        <div class="upload-box" id="dropZone">
          <i class="fa-solid fa-cloud-arrow-up fa-4x"></i>
          <h3 style="font-size: 20px">Kéo thả file vào đây</h3>
          <p>
            Hệ thống sẽ upload vào
            <b style="color: var(--primary-color)">Server đang chọn</b>
          </p>
          <div class="paste-hint">
            <i class="fa-regular fa-keyboard"></i> Hỗ trợ Ctrl+V để dán ảnh
          </div>
          <input type="file" id="fileInput" multiple hidden />
        </div>

        <div class="result-header">
          <span>
            <i class="fa-solid fa-circle-info"></i> Danh sách vừa thêm
          </span>
          <button
            class="btn btn-clear btn-sm"
            onclick="clearResultList()"
            title="Xóa danh sách hiển thị bên dưới"
          >
            <i class="fa-solid fa-trash"></i> Xóa list
          </button>
        </div>
        <div id="resultList"></div>
      </div>

      <div id="view-gallery" class="view-section hidden">
        <h3 class="history-section-title">
          <span
            ><i class="fa-solid fa-clock-rotate-left"></i> Dữ liệu trên
            Drive</span
          >
          <button class="btn btn-theme" onclick="switchView('upload')">
            <i class="fa-solid fa-arrow-left"></i> Quay lại Upload
          </button>
        </h3>
        <p
          style="
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 20px;
            text-align: center;
          "
        >
          <i class="fa-solid fa-circle-info"></i> Danh sách sẽ tự động cập nhật.
        </p>

        <div class="history-grid" id="historyGrid"></div>
      </div>

      <div id="view-admin" class="view-section hidden">
        <h3 class="history-section-title">
          <span
            ><i class="fa-solid fa-shield-halved"></i> Quản Trị Viên
            (Admin)</span
          >
          <button class="btn btn-clear" onclick="exitAdmin()">
            <i class="fa-solid fa-right-from-bracket"></i> Thoát Admin
          </button>
        </h3>

        <p
          style="
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 5px;
          "
        >
          <i class="fa-solid fa-chart-pie"></i> Tổng quan dung lượng các Server
        </p>
        <div id="adminGrid" class="admin-grid">
          <p>Đang tải dữ liệu...</p>
        </div>

        <div class="admin-manager-box">
          <h4 style="margin: 0 0 15px 0; color: var(--primary-color)">
            <i class="fa-solid fa-folder-open"></i> Quản lý File & Dọn dẹp
          </h4>

          <div class="admin-controls">
            <select
              id="adminServerSelect"
              class="server-select"
              onchange="loadAdminFiles()"
            ></select>
            <button class="btn btn-theme" onclick="loadAdminFiles()">
              <i class="fa-solid fa-rotate"></i> Tải lại
            </button>

            <div id="bulkActionBox" class="bulk-actions">
              <span id="selectedCount" class="bulk-text">0 file</span>
              <button
                class="btn btn-delete-all btn-sm"
                onclick="deleteSelectedFiles()"
              >
                <i class="fa-solid fa-trash-check"></i> Xóa đã chọn
              </button>
            </div>

            <button
              class="btn btn-scan"
              onclick="scanDuplicates()"
              style="margin-left: auto"
            >
              <i class="fa-solid fa-magnifying-glass"></i> Quét file trùng
            </button>

            <button
              class="btn btn-clear"
              onclick="emptyDriveTrash()"
              style="background: #636e72; color: white"
            >
              <i class="fa-solid fa-dumpster"></i> Dọn thùng rác
            </button>

            <button
              class="btn btn-delete-all"
              id="btnDeleteDup"
              style="display: none"
              onclick="deleteDuplicates()"
            >
              <i class="fa-solid fa-trash-can"></i> Xóa tất cả file trùng
            </button>
          </div>

          <div
            id="adminStatusMsg"
            style="
              margin-bottom: 10px;
              font-weight: 600;
              color: var(--text-color);
            "
          ></div>

          <div class="admin-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th style="width: 40px; text-align: center">
                    <input
                      type="checkbox"
                      id="selectAllBox"
                      class="custom-checkbox"
                      onchange="toggleSelectAll()"
                    />
                  </th>
                  <th>Tên File</th>
                  <th>Kích thước</th>
                  <th>Ngày tạo</th>
                  <th>Hành động</th>
                </tr>
              </thead>
              <tbody id="adminFileList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "";

      const fileInput = document.getElementById("fileInput");
      const dropZone = document.getElementById("dropZone");
      const resultList = document.getElementById("resultList");
      const loadingBox = document.getElementById("loadingBox");
      const toastContainer = document.getElementById("toast-container");
      const serverSelect = document.getElementById("serverSelect");
      const elCountDrive = document.getElementById("count-drive");
      const urlInput = document.getElementById("urlInput");

      const viewUpload = document.getElementById("view-upload");
      const viewGallery = document.getElementById("view-gallery");
      const viewAdmin = document.getElementById("view-admin");
      const historyGrid = document.getElementById("historyGrid");
      const linkModal = document.getElementById("linkModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalPreview = document.getElementById("modalPreview");
      const modalLinks = document.getElementById("modalLinks");
      const adminPassModal = document.getElementById("adminPassModal");
      const adminPassInput = document.getElementById("adminPassInput");
      const adminGrid = document.getElementById("adminGrid");

      const adminServerSelect = document.getElementById("adminServerSelect");
      const adminFileList = document.getElementById("adminFileList");
      const adminStatusMsg = document.getElementById("adminStatusMsg");
      const btnDeleteDup = document.getElementById("btnDeleteDup");

      const adminPreviewModal = document.getElementById("adminPreviewModal");
      const adminPreviewTitle = document.getElementById("adminPreviewTitle");
      const adminPreviewContent = document.getElementById(
        "adminPreviewContent"
      );

      let autoRefreshInterval = null;
      let lastDataSignature = null;
      let currentAdminToken = "";

      let adminFilesCache = [];
      let duplicateFiles = [];

      let selectedIds = new Set();

      initTheme();
      createSnow();
      loadServers();

      function switchView(viewName) {
        if (currentAdminToken !== "" && viewName !== "admin") {
          showToast(
            "Bạn phải 'Thoát Admin' trước khi chuyển sang mục khác!",
            "error"
          );
          return;
        }

        viewUpload.classList.add("hidden");
        viewGallery.classList.add("hidden");
        viewAdmin.classList.add("hidden");

        if (viewName === "admin") {
          viewAdmin.classList.remove("hidden");
          loadAdminData();
          loadAdminFiles();
        } else if (viewName === "gallery") {
          viewGallery.classList.remove("hidden");
          loadDriveFiles(false);
        } else {
          viewUpload.classList.remove("hidden");
          loadStats(true);
        }
      }

      function openAdminModal() {
        adminPassModal.style.display = "flex";
        adminPassInput.value = "";
        adminPassInput.focus();
      }

      function closeAdminModal() {
        adminPassModal.style.display = "none";

        const loginBtn = document.querySelector(
          "#adminPassModal .btn-warehouse"
        );
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.innerHTML =
            '<i class="fa-solid fa-right-to-bracket"></i> Đăng nhập';
        }
      }

      async function verifyAdmin() {
        const pass = adminPassInput.value;
        if (!pass) return showToast("Vui lòng nhập mật khẩu", "error");

        const loginBtn = document.querySelector(
          "#adminPassModal .btn-warehouse"
        );
        const originalText =
          '<i class="fa-solid fa-right-to-bracket"></i> Đăng nhập';

        loginBtn.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Đang xác thực...';
        loginBtn.disabled = true;

        try {
          const res = await fetch(`${API_URL}/admin/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: pass }),
          });
          const json = await res.json();

          if (json.success) {
            currentAdminToken = pass;

            closeAdminModal();

            loginBtn.disabled = false;
            loginBtn.innerHTML = originalText;

            if (serverSelect.options.length > 0) {
              adminServerSelect.innerHTML = serverSelect.innerHTML;
              adminServerSelect.value = serverSelect.value;
            }

            document.querySelector(".btn-admin").style.display = "none";
            document.querySelector(".btn-warehouse").style.display = "none";
            document.querySelector(".btn-export").style.display = "none";

            switchView("admin");
            showToast("Đã xác thực quyền Admin!", "success");
          } else {
            showToast("Mật khẩu không chính xác!", "error");
            loginBtn.disabled = false;
            loginBtn.innerHTML = originalText;
          }
        } catch (e) {
          showToast("Lỗi kết nối Server", "error");
          loginBtn.disabled = false;
          loginBtn.innerHTML = originalText;
        }
      }

      function exitAdmin() {
        currentAdminToken = "";

        localStorage.removeItem("adminToken");

        document.querySelector(".btn-admin").style.display = "flex";
        document.querySelector(".btn-warehouse").style.display = "flex";
        document.querySelector(".btn-export").style.display = "flex";

        const loginBtn = document.querySelector(
          "#adminPassModal .btn-warehouse"
        );
        loginBtn.disabled = false;
        loginBtn.innerHTML =
          '<i class="fa-solid fa-right-to-bracket"></i> Đăng nhập';

        switchView("upload");
        showToast("Đã thoát chế độ Admin");
      }

      function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return "0 Bytes";
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${
          sizes[i]
        }`;
      }

      async function loadAdminData() {
        adminGrid.innerHTML =
          '<div style="grid-column:1/-1; text-align:center;"><div class="spinner" style="margin:0 auto; width:40px; height:40px; border-color:var(--primary-color); border-top-color:transparent;"></div></div>';

        try {
          const res = await fetch(`${API_URL}/admin/stats-all`, {
            headers: { "x-admin-pass": currentAdminToken },
          });
          const json = await res.json();

          if (json.success) {
            adminGrid.innerHTML = "";
            json.servers.forEach((sv) => {
              const limit = sv.bytes_Limit;
              const total = sv.bytes_Total;

              const safeLimit = limit > 0 ? limit : 1;

              const p1 = (sv.bytes_Web / safeLimit) * 100;
              const p2 = (sv.bytes_OtherDrive / safeLimit) * 100;
              const p3 = (sv.bytes_Gmail / safeLimit) * 100;

              const totalPercent = ((total / safeLimit) * 100).toFixed(2);

              const card = document.createElement("div");
              card.className = "admin-card";

              card.innerHTML = `
                  <h3 style="border-bottom:1px solid var(--glass-border); padding-bottom:10px; margin-bottom:15px;">
                     <i class="fa-solid fa-server"></i> ${sv.name}
                  </h3>

                  <div style="margin-bottom:10px; font-size:13px; font-weight:600; color:var(--text-secondary)">
                      Chi tiết tài nguyên (Data thật):
                  </div>

                  <div style="display:flex; height:12px; border-radius:6px; overflow:hidden; background:rgba(0,0,0,0.1); margin-bottom:15px;">
                      <div style="width:${p1}%; background:#6c5ce7;" title="Web: ${formatBytes(
                sv.bytes_Web
              )}"></div>
                      <div style="width:${p2}%; background:#0984e3;" title="Drive Khác: ${formatBytes(
                sv.bytes_OtherDrive
              )}"></div>
                      <div style="width:${p3}%; background:#fab1a0;" title="Gmail: ${formatBytes(
                sv.bytes_Gmail
              )}"></div>
                  </div>

                  <div style="display:flex; flex-direction:column; gap:8px; font-size:13px;">
                      
                      <div style="display:flex; justify-content:space-between; align-items:center;">
                          <div style="display:flex; align-items:center; gap:8px;">
                              <span style="width:10px; height:10px; background:#6c5ce7; border-radius:2px;"></span>
                              <span>Web Upload</span>
                          </div>
                          <strong style="color:#6c5ce7">${formatBytes(
                            sv.bytes_Web
                          )}</strong>
                      </div>

                      <div style="display:flex; justify-content:space-between; align-items:center;">
                          <div style="display:flex; align-items:center; gap:8px;">
                              <span style="width:10px; height:10px; background:#0984e3; border-radius:2px;"></span>
                              <span>File Drive Khác</span>
                          </div>
                          <strong>${formatBytes(sv.bytes_OtherDrive)}</strong>
                      </div>

                      <div style="display:flex; justify-content:space-between; align-items:center;">
                          <div style="display:flex; align-items:center; gap:8px;">
                              <span style="width:10px; height:10px; background:#fab1a0; border-radius:2px;"></span>
                              <span>Gmail & Photos</span>
                          </div>
                          <strong>${formatBytes(sv.bytes_Gmail)}</strong>
                      </div>

                  </div>

                  <div style="border-top:1px dashed var(--glass-border); margin-top:15px; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                      <span style="font-size:12px; font-weight:700; color:var(--text-secondary)">TỔNG ĐÃ DÙNG</span>
                      <span style="font-weight:800; color:var(--text-color)">
                        ${formatBytes(total)} / ${formatBytes(
                limit
              )} (${totalPercent}%)
                      </span>
                  </div>
              `;
              adminGrid.appendChild(card);
            });
          }
        } catch (e) {
          console.error(e);
          adminGrid.innerHTML =
            '<p style="color:red; text-align:center;">Lỗi hiển thị!</p>';
        }
      }

      async function loadAdminFiles() {
        const index = adminServerSelect.value || 0;
        adminFileList.innerHTML =
          '<tr><td colspan="5" style="text-align:center;">Đang tải dữ liệu từ Google Drive...</td></tr>';
        btnDeleteDup.style.display = "none";
        adminStatusMsg.innerText = "";
        duplicateFiles = [];
        adminFilesCache = [];

        try {
          const res = await fetch(`${API_URL}/admin/files/${index}`, {
            headers: { "x-admin-pass": currentAdminToken },
          });
          const data = await res.json();

          if (!data.success) {
            adminFileList.innerHTML = `<tr><td colspan="5" style="color:red;">Lỗi: ${data.message}</td></tr>`;
            return;
          }

          adminFilesCache = data.files || [];
          adminStatusMsg.innerHTML = `Tổng số file: ${adminFilesCache.length}`;
          renderAdminTable(adminFilesCache);
        } catch (error) {
          adminFileList.innerHTML = `<tr><td colspan="5" style="color:red;">Lỗi kết nối Server</td></tr>`;
        }
      }

      function renderAdminTable(files) {
        const tbody = document.getElementById("adminFileList");
        tbody.innerHTML = "";

        selectedIds.clear();
        updateBulkUI();
        document.getElementById("selectAllBox").checked = false;

        if (files.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center;">Thư mục trống.</td></tr>';
          return;
        }

        files.forEach((file) => {
          const isDup = duplicateFiles.find((d) => d.id === file.id);
          const rowClass = isDup ? "duplicate-row" : "";
          const sizeMB = (file.size / (1024 * 1024)).toFixed(2) + " MB";
          const date = new Date(file.createdTime).toLocaleString("vi-VN");

          const tr = document.createElement("tr");
          tr.className = rowClass;
          tr.id = `row-${file.id}`;

          tr.innerHTML = `
            <td style="text-align: center;">
                <input type="checkbox" class="custom-checkbox file-checkbox" 
                       value="${file.id}" 
                       onchange="toggleFile('${file.id}')">
            </td>
            <td>
                <span class="admin-file-link" onclick="viewAdminFile('${
                  file.id
                }')">
                        <i class="fa-solid fa-eye"></i> ${file.name}
                </span>
                ${isDup ? '<span class="dup-badge">Trùng lặp</span>' : ""}
            </td>
            <td>${sizeMB}</td>
            <td>${date}</td>
            <td>
                <button class="btn btn-theme btn-sm" style="margin-right: 5px;" onclick="renameFile('${
                  file.id
                }', '${file.name.replace(/'/g, "\\'")}')">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                
                <button class="btn btn-clear btn-sm" onclick="deleteSingleFile('${
                  file.id
                }')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function toggleFile(id) {
        if (selectedIds.has(id)) selectedIds.delete(id);
        else selectedIds.add(id);
        updateBulkUI();
      }

      function toggleSelectAll() {
        const isChecked = document.getElementById("selectAllBox").checked;
        const boxes = document.querySelectorAll(".file-checkbox");
        selectedIds.clear();

        boxes.forEach((box) => {
          box.checked = isChecked;
          if (isChecked) selectedIds.add(box.value);
        });
        updateBulkUI();
      }

      function updateBulkUI() {
        const box = document.getElementById("bulkActionBox");
        const label = document.getElementById("selectedCount");

        if (selectedIds.size > 0) {
          box.style.display = "flex";
          label.innerText = `${selectedIds.size} file`;
        } else {
          box.style.display = "none";
        }
      }

      async function deleteSelectedFiles() {
        const count = selectedIds.size;
        if (count === 0) {
          showToast("Chưa chọn file nào!", "error");
          return;
        }

        if (!confirm(`Bạn chắc chắn muốn XÓA VĨNH VIỄN ${count} file này?`))
          return;

        const btn = document.querySelector(".btn-delete-all");

        const originalContent = btn.innerHTML;

        btn.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Đang xóa...';
        btn.disabled = true;

        try {
          const res = await fetch(`${API_URL}/admin/delete-multiple`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-pass": currentAdminToken,
            },
            body: JSON.stringify({ fileIds: Array.from(selectedIds) }),
          });
          const json = await res.json();

          if (json.success) {
            showToast(json.message, "success");

            selectedIds.forEach((id) => {
              const row = document.getElementById(`row-${id}`);
              if (row) row.remove();

              adminFilesCache = adminFilesCache.filter((f) => f.id !== id);
            });

            selectedIds.clear();
            updateBulkUI();
            const selectAllBox = document.getElementById("selectAllBox");
            if (selectAllBox) selectAllBox.checked = false;

            loadAdminData();
          } else {
            showToast("Lỗi: " + json.message, "error");
          }
        } catch (e) {
          console.error(e);
          showToast("Lỗi kết nối Server!", "error");
        } finally {
          btn.innerHTML = originalContent;
          btn.disabled = false;
        }
      }

      function viewAdminFile(fileId) {
        const file = adminFilesCache.find((f) => f.id === fileId);
        if (!file) return;

        adminPreviewTitle.innerText = file.name;
        adminPreviewContent.innerHTML =
          '<div class="spinner" style="border-color:var(--primary-color); border-top-color:transparent; margin: 50px auto;"></div>';

        const btnDelete = document.getElementById("btnDeleteInModal");
        btnDelete.onclick = async () => {
          if (confirm(`Bạn chắc chắn muốn xóa vĩnh viễn file: ${file.name}?`)) {
            const success = await performDeleteInModal(file.id);
            if (success) {
              closeAdminPreview();
              showToast("Đã xóa file thành công!");
            }
          }
        };

        let previewHtml = "";
        const mime = file.mimeType || "";
        const embedLink = file.webViewLink.replace("/view", "/preview");

        if (mime.startsWith("image/")) {
          const imgSrc = `https://drive.google.com/thumbnail?id=${file.id}&sz=w5000`;
          previewHtml = `<img src="${imgSrc}" class="modal-img-preview" style="max-height: 70vh; max-width: 100%; object-fit: contain; border-radius: 8px;"/>`;
        } else if (mime.startsWith("video/")) {
          previewHtml = `<iframe src="${embedLink}" width="100%" height="400" frameborder="0" allowfullscreen style="border-radius:12px;"></iframe>`;
        } else {
          previewHtml = `<div style="padding: 40px; color: white;"><i class="fa-solid fa-file-zipper fa-4x"></i><p>Không hỗ trợ xem trước.</p></div>`;
        }

        adminPreviewContent.innerHTML = previewHtml;
        adminPreviewModal.style.display = "flex";
      }

      async function performDeleteInModal(fileId) {
        const serverIndex =
          document.getElementById("adminServerSelect").value || 0;
        try {
          const res = await fetch(
            `${API_URL}/admin/files/${serverIndex}/${fileId}`,
            {
              method: "DELETE",
              headers: { "x-admin-pass": currentAdminToken },
            }
          );
          const data = await res.json();
          if (data.success) {
            const row = document.getElementById(`row-${fileId}`);
            if (row) row.remove();

            adminFilesCache = adminFilesCache.filter((f) => f.id !== fileId);

            loadAdminData();
            return true;
          } else {
            alert("Lỗi: " + data.message);
            return false;
          }
        } catch (e) {
          alert("Lỗi kết nối server");
          return false;
        }
      }

      function closeAdminPreview() {
        adminPreviewModal.style.display = "none";
        adminPreviewContent.innerHTML = "";
      }
      adminPreviewModal.addEventListener("click", (e) => {
        if (e.target === adminPreviewModal) closeAdminPreview();
      });

      function scanDuplicates() {
        if (adminFilesCache.length === 0) return;

        const map = new Map();
        duplicateFiles = [];

        adminFilesCache.forEach((file) => {
          if (file.md5Checksum) {
            if (!map.has(file.md5Checksum)) {
              map.set(file.md5Checksum, []);
            }
            map.get(file.md5Checksum).push(file);
          }
        });

        let groupCount = 0;
        map.forEach((group) => {
          if (group.length > 1) {
            groupCount++;

            group.sort(
              (a, b) => new Date(a.createdTime) - new Date(b.createdTime)
            );

            for (let i = 1; i < group.length; i++) {
              duplicateFiles.push(group[i]);
            }
          }
        });

        if (duplicateFiles.length > 0) {
          adminStatusMsg.innerHTML = `<span style="color:var(--warning-color)">⚠️ Tìm thấy ${duplicateFiles.length} file thừa (trong ${groupCount} nhóm trùng nội dung).</span>`;
          btnDeleteDup.style.display = "inline-flex";
          renderAdminTable(adminFilesCache);
        } else {
          showToast("Không tìm thấy file trùng lặp!");
          adminStatusMsg.innerHTML =
            "File hệ thống sạch sẽ, không có trùng lặp.";
        }
      }

      async function deleteSingleFile(fileId) {
        if (!confirm("Bạn chắc chắn muốn xóa file này vĩnh viễn?")) return;

        const index = adminServerSelect.value;
        try {
          const res = await fetch(`${API_URL}/admin/files/${index}/${fileId}`, {
            method: "DELETE",
            headers: { "x-admin-pass": currentAdminToken },
          });
          const data = await res.json();

          if (data.success) {
            const row = document.getElementById(`row-${fileId}`);
            if (row) row.remove();

            adminFilesCache = adminFilesCache.filter((f) => f.id !== fileId);
            showToast("Đã xóa file.");
            loadAdminData();
          } else {
            showToast("Lỗi: " + data.message, "error");
          }
        } catch (e) {
          showToast("Lỗi kết nối", "error");
        }
      }

      async function deleteDuplicates() {
        if (
          !confirm(
            `CẢNH BÁO: Bạn sắp xóa vĩnh viễn ${duplicateFiles.length} file trùng lặp. Hành động này không thể hoàn tác. Tiếp tục?`
          )
        )
          return;

        btnDeleteDup.disabled = true;
        btnDeleteDup.innerHTML =
          '<i class="fa-solid fa-circle-notch fa-spin"></i> Đang xóa...';

        let count = 0;
        const index = adminServerSelect.value;

        for (const file of duplicateFiles) {
          try {
            const res = await fetch(
              `${API_URL}/admin/files/${index}/${file.id}`,
              {
                method: "DELETE",
                headers: { "x-admin-pass": currentAdminToken },
              }
            );
            const data = await res.json();
            if (data.success) {
              count++;
              const row = document.getElementById(`row-${file.id}`);
              if (row) row.remove();
            }
          } catch (e) {
            console.log(e);
          }
        }

        btnDeleteDup.style.display = "none";
        btnDeleteDup.disabled = false;
        btnDeleteDup.innerHTML =
          '<i class="fa-solid fa-trash-can"></i> Xóa tất cả file trùng';

        showToast(`Đã xóa sạch ${count} file trùng lặp!`, "success");
        setTimeout(() => {
          loadAdminFiles();
          loadAdminData();
        }, 1000);
      }

      async function loadDriveFiles(isSilent = false) {
        if (!isSilent && !lastDataSignature) {
          historyGrid.innerHTML =
            '<div style="grid-column:1/-1; text-align:center; padding:40px;"><i class="fa-solid fa-circle-notch fa-spin fa-2x" style="color:var(--primary-color)"></i><p>Đang đồng bộ dữ liệu từ Drive...</p></div>';
        }
        try {
          const index = serverSelect.value || 0;
          const res = await fetch(`${API_URL}/files?index=${index}`);
          const json = await res.json();

          if (json.success) {
            const currentSignature = JSON.stringify(
              json.files.map((f) => f.id + f.name)
            );
            if (lastDataSignature === currentSignature) return;

            lastDataSignature = currentSignature;
            if (json.files.length > 0) {
              historyGrid.innerHTML = "";
              json.files.forEach((file) => {
                const item = processDriveData(file);
                const card = createHistoryCard(item);
                historyGrid.appendChild(card);
              });
            } else {
              historyGrid.innerHTML =
                '<div style="grid-column:1/-1; text-align:center; padding: 40px; color: var(--text-secondary)"><i class="fa-regular fa-folder-open fa-3x"></i><p>Thư mục trống</p></div>';
            }
          }
        } catch (e) {
          console.error(e);
          if (!isSilent) {
            historyGrid.innerHTML =
              '<div style="grid-column:1/-1; text-align:center; color:#ff7675; padding: 20px;">Lỗi kết nối Server!</div>';
          }
        }
      }

      function processDriveData(file) {
        let type = "file";

        const link = file.webViewLink || file.driveLink || "";
        const mime = file.mimeType || "";
        const thumb = file.thumbnailLink || "";

        if (mime.startsWith("image/")) type = "image";
        else if (mime.startsWith("video/")) type = "video";
        else if (mime.startsWith("audio/")) type = "audio";

        let playerLink = link ? link.replace("/view", "/preview") : "";
        let driveLink = link;

        let directImageLink = "";
        if (type === "image") {
          if (thumb) {
            directImageLink = thumb.replace(/=s\d+/, "=s10000");
          } else if (file.id) {
            directImageLink = `https://drive.google.com/uc?export=view&id=${file.id}`;
          }
        }

        return {
          id: file.id || "unknown_" + Date.now(),
          name: file.name || "Không tên",
          thumb: thumb,
          type: type,
          playerLink: playerLink,
          driveLink: driveLink,
          directImageLink: directImageLink,
        };
      }

      function createHistoryCard(item) {
        const card = document.createElement("div");
        card.className = "history-card";
        card.onclick = () => openModal(item);

        let icon = "";
        if (item.type === "video") icon = '<i class="fa-solid fa-video"></i>';
        if (item.type === "audio") icon = '<i class="fa-solid fa-music"></i>';

        let imgSrc = item.thumb;
        if (item.type === "image" && imgSrc)
          imgSrc = imgSrc.replace(/=s\d+/, "=s300");
        if (!imgSrc || item.type === "audio")
          imgSrc = "https://cdn-icons-png.flaticon.com/512/2965/2965358.png";

        card.innerHTML = `
      <img src="${imgSrc}" class="history-thumb" loading="lazy" referrerpolicy="no-referrer" onerror="this.src='https://placehold.co/150?text=File'"/>
      ${icon ? `<div class="history-type-icon">${icon}</div>` : ""}
    `;
        return card;
      }

      function changeServer() {
        lastDataSignature = null;
        loadStats(true);
        if (!viewGallery.classList.contains("hidden")) {
          loadDriveFiles(false);
        }
        showToast(
          `Đang kết nối: ${
            serverSelect.options[serverSelect.selectedIndex].text
          }`
        );
      }

      function renderItem(item) {
        const div = document.createElement("div");
        div.className = "result-item";
        div.style.animationDelay = "0.1s";
        let thumbHTML = "";

        const downloadLink = `https://drive.google.com/uc?export=download&id=${item.id}`;

        if (item.type === "image") {
          thumbHTML = `<img src="${item.directImageLink}" class="thumb-img" loading="lazy" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/512/3342/3342137.png'" />`;
        } else if (item.type === "video") {
          const poster = item.thumb
            ? `<img src="${item.thumb}" class="video-thumb-bg" referrerpolicy="no-referrer">`
            : `<div class="video-thumb-bg" style="background:#333"></div>`;
          thumbHTML = `
        <div class="video-placeholder" id="video-place-${item.id}">
            ${poster}
            <div class="play-btn-overlay" onclick="playVideo('${item.id}', '${item.playerLink}')">
                <i class="fa-solid fa-play"></i>
            </div>
        </div>
        <div class="video-controls">
           <a href="${item.playerLink}" target="_blank" class="btn-play btn-google" style="text-decoration:none">
              <i class="fa-solid fa-up-right-from-square"></i> Mở tab mới
           </a>
        </div>
      `;
        } else if (item.type === "audio") {
          thumbHTML = `
        <div style="width:100%; display:flex; flex-direction:column; align-items:center; gap:10px;">
            <div class="audio-icon-box" style="width:100%; height:100px;">
                <i class="fa-solid fa-music fa-2x"></i>
                <span style="font-size:10px; margin-top:5px; padding:0 10px; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">${item.name}</span>
            </div>
            <iframe src="${item.playerLink}" width="100%" height="80" frameborder="0" allow="autoplay"></iframe>
        </div>
        `;
        } else
          thumbHTML = `<div class="file-icon"><i class="fa-solid fa-file-zipper"></i></div>`;

        let linkXemContent = item.playerLink;
        if (item.type === "image") linkXemContent = item.directImageLink;

        const htmlCode =
          item.type === "image"
            ? `<img src="${item.directImageLink}" alt="${item.name}" />`
            : `<iframe src="${item.playerLink}" width="640" height="480" allow="autoplay"></iframe>`;

        div.innerHTML = `
    <div class="thumb-col">${thumbHTML}</div>
    <div class="links-col">
        ${createInputRow("Link Trực Tiếp (Player / Embed)", linkXemContent)}
        ${createInputRow("Link Google Drive (Gốc)", item.driveLink)} 
        
        ${
          item.type === "image"
            ? createInputRow("Link Tải Về (Full HD/Gốc)", downloadLink)
            : createInputRow("Mã Nhúng (Embed)", htmlCode)
        }
        
        ${
          item.type === "image"
            ? createInputRow("Mã Nhúng (Embed)", htmlCode)
            : ""
        }
    </div>`;
        resultList.prepend(div);
      }

      function openModal(item) {
        modalTitle.innerText = item.name;
        modalLinks.innerHTML = "";
        modalPreview.innerHTML = "";

        const downloadLink = `https://drive.google.com/uc?export=download&id=${item.id}`;

        let linkXemContent = item.playerLink;
        if (item.type === "image") linkXemContent = item.directImageLink;

        const htmlCode =
          item.type === "image"
            ? `<img src="${item.directImageLink}" alt="${item.name}" />`
            : `<iframe src="${item.playerLink}" width="640" height="480" allow="autoplay"></iframe>`;

        if (item.type === "image") {
          modalPreview.innerHTML = `<img src="${item.directImageLink}" class="modal-img-preview" referrerpolicy="no-referrer" />`;
        } else if (item.type === "video") {
          modalPreview.innerHTML = `<iframe src="${item.playerLink}" width="100%" height="100%" frameborder="0" allowfullscreen style="height:300px"></iframe>`;
        } else if (item.type === "audio") {
          modalPreview.innerHTML = `
        <div style="text-align:center; color:white;">
            <i class="fa-solid fa-music fa-3x" style="margin-bottom:10px"></i><br>
            <iframe src="${item.playerLink}" width="100%" height="100" frameborder="0"></iframe>
        </div>
        `;
        } else {
          modalPreview.innerHTML = `<i class="fa-solid fa-file-zipper fa-4x" style="color:white"></i>`;
        }

        modalLinks.innerHTML += createInputRow(
          "Link Trực Tiếp (Player / Embed)",
          linkXemContent
        );
        modalLinks.innerHTML += createInputRow(
          "Link Google Drive (Gốc)",
          item.driveLink
        );

        if (item.type === "image") {
          modalLinks.innerHTML += createInputRow(
            "Link Tải Về (Full HD/Gốc)",
            downloadLink
          );
        }

        modalLinks.innerHTML += createInputRow("Mã Nhúng", htmlCode);

        linkModal.style.display = "flex";
      }

      function closeModal() {
        linkModal.style.display = "none";
        modalPreview.innerHTML = "";
      }
      linkModal.addEventListener("click", (e) => {
        if (e.target === linkModal) closeModal();
      });

      function playVideo(id, playerLink) {
        const container = document.getElementById(`video-place-${id}`);
        container.innerHTML = `<iframe src="${playerLink}" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>`;
        container.style.background = "black";
      }

      function createInputRow(l, v) {
        if (!v) v = "";
        const safeValue = v.replace(/"/g, "&quot;").replace(/'/g, "\\'");

        return `
    <div class="input-group">
      <label class="input-label">${l}</label>
      <div class="input-wrapper">
        <input type="text" class="link-input" value="${safeValue}" readonly>
        <button class="btn-copy" onclick="copyToClipboard(this, '${safeValue}')">
          <i class="fa-regular fa-copy"></i>
        </button>
      </div>
    </div>`;
      }
      function copyToClipboard(btn, text) {
        navigator.clipboard.writeText(text).then(() => {
          const i = btn.querySelector("i");
          i.className = "fa-solid fa-check";
          i.style.color = "#fff";
          btn.style.background = "#00b894";
          setTimeout(() => {
            i.className = "fa-regular fa-copy";
            btn.style.background = "";
          }, 1500);
        });
      }
      function showToast(m, t = "success") {
        const d = document.createElement("div");
        d.className = `toast ${t}`;
        d.innerHTML = `<i class="fa-solid ${
          t === "success" ? "fa-circle-check" : "fa-circle-exclamation"
        }"></i><span>${m}</span>`;
        toastContainer.appendChild(d);
        setTimeout(() => {
          d.style.animation = "slideLeft 0.4s reverse forwards";
          setTimeout(() => d.remove(), 400);
        }, 3000);
      }
      function initTheme() {
        document.documentElement.setAttribute(
          "data-theme",
          localStorage.getItem("theme") || "light"
        );
        updateThemeIcon(localStorage.getItem("theme") || "light");
      }
      function toggleTheme() {
        const n =
          document.documentElement.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
        document.documentElement.setAttribute("data-theme", n);
        localStorage.setItem("theme", n);
        updateThemeIcon(n);
      }
      function updateThemeIcon(t) {
        document.getElementById("theme-icon").className =
          t === "dark" ? "fa-solid fa-sun" : "fa-solid fa-moon";
      }

      function createSnow() {
        const container = document.getElementById("snow-container");
        container.innerHTML = "";
        const count = 50;

        for (let i = 0; i < count; i++) {
          const flake = document.createElement("div");
          flake.className = "snowflake";

          const size = Math.random() * 6 + 2;
          const opacity = Math.random() * 0.7 + 0.3;
          const duration = Math.random() * 10 + 10;
          const delay = Math.random() * -20;
          const blur = Math.random() * 2;

          Object.assign(flake.style, {
            width: `${size}px`,
            height: `${size}px`,
            left: `${Math.random() * 100}vw`,
            opacity: opacity,
            filter: `blur(${blur}px)`,
            animationDuration: `${duration}s, ${Math.random() * 3 + 2}s`,
            animationDelay: `${delay}s, ${Math.random() * 5}s`,
          });

          container.appendChild(flake);
        }
      }

      async function autoCheckAdmin() {
        const savedToken = localStorage.getItem("adminToken");
        if (savedToken) {
          adminPassInput.value = savedToken;

          await verifyAdmin();
        }
      }

      window.onload = () => {
        initTheme();
        createSnow();
        loadServers();
      };

      const title = document.querySelector(".title");
      title.innerHTML = title.innerText
        .split("")
        .map(
          (char, i) =>
            `<span style="display:inline-block; animation: wave 2s infinite ${
              i * 0.1
            }s">${char === " " ? "&nbsp;" : char}</span>`
        )
        .join("");

      function saveHistory(i) {
        try {
          let raw = localStorage.getItem("uploadHistory");
          let l = [];

          if (raw) {
            try {
              l = JSON.parse(raw);
              if (!Array.isArray(l)) l = [];
            } catch (e) {
              l = [];
            }
          }

          if (i.id) {
            l = l.filter((x) => x.id !== i.id);
          }

          l.push(i);
          if (l.length > 100) l.shift();
          localStorage.setItem("uploadHistory", JSON.stringify(l));
        } catch (e) {
          console.warn("Không thể lưu lịch sử:", e);
        }
      }

      function clearResultList() {
        const list = document.getElementById("resultList");
        if (!list.innerHTML.trim()) {
          showToast("Danh sách đã trống!", "error");
          return;
        }
        if (confirm("Bạn có chắc muốn xóa danh sách các file vừa upload?")) {
          list.style.opacity = "0";
          list.style.transform = "translateY(10px)";
          setTimeout(() => {
            list.innerHTML = "";
            list.style.opacity = "1";
            list.style.transform = "translateY(0)";
            showToast("Đã làm mới danh sách.");
          }, 300);
        }
      }

      document.addEventListener("paste", function (event) {
        if (viewUpload.classList.contains("hidden")) return;
        const items = (event.clipboardData || event.originalEvent.clipboardData)
          .items;
        const files = [];
        for (let index in items) {
          const item = items[index];
          if (item.kind === "file") {
            const blob = item.getAsFile();
            files.push(blob);
          }
        }
        if (files.length > 0) {
          showToast("Đang đọc dữ liệu từ Clipboard...");
          handleFiles(files);
        }
      });

      adminPassInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          verifyAdmin();
        }
      });

      async function loadServers() {
        try {
          const res = await fetch(`${API_URL}/accounts`);
          const json = await res.json();
          if (json.success && json.accounts.length > 0) {
            serverSelect.innerHTML = json.accounts
              .map((acc) => `<option value="${acc.index}">${acc.name}</option>`)
              .join("");
            loadStats();
          } else {
            serverSelect.innerHTML = `<option value="0">Server Mặc định</option>`;
            loadStats();
          }
        } catch (e) {
          console.warn("Chưa kết nối được Server danh sách");
          serverSelect.innerHTML = `<option value="0">Server Offline</option>`;
          elCountDrive.innerText = "Offline";
        }
      }

      async function loadStats(force = false) {
        const totalUploaded = localStorage.getItem("lifetimeUploadCount") || 0;
        document.getElementById("count-uploaded").innerText = totalUploaded;

        const elUsed = document.getElementById("storage-used");
        const elTotal = document.getElementById("storage-total");
        const elBar = document.getElementById("storage-bar");

        try {
          if (force) {
            const btn = document.querySelector(".refresh-btn i");
            if (btn) btn.classList.add("fa-spin");
          } else {
            if (elCountDrive.innerText === "Offline")
              elCountDrive.innerText = "...";
          }

          const index = serverSelect.value || 0;
          const res = await fetch(`${API_URL}/stats?index=${index}`);
          const json = await res.json();

          if (json.success) {
            elCountDrive.innerText = json.totalFiles;
            if (json.storage) {
              elUsed.innerText = json.storage.used + " GB";
              elTotal.innerText = json.storage.total + " GB";
              elBar.style.width = json.storage.percent + "%";
              if (json.storage.percent > 90) elBar.style.background = "#ff7675";
              else
                elBar.style.background =
                  "linear-gradient(90deg, #0984e3, #74b9ff)";
            }
          }
        } catch (err) {
          console.warn(err);
          elCountDrive.innerText = "Offline";
        } finally {
          const btn = document.querySelector(".refresh-btn i");
          if (btn) btn.classList.remove("fa-spin");
        }
      }

      async function uploadFromUrl() {
        const url = urlInput.value.trim();
        if (!url) {
          showToast("Vui lòng nhập link ảnh!", "error");
          return;
        }
        loadingBox.style.display = "flex";
        updateLoadingText(0, 1);

        try {
          const currentServerIndex = serverSelect.value || 0;
          const res = await fetch(`${API_URL}/upload-url`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              url: url,
              accountIndex: currentServerIndex,
            }),
          });
          const json = await res.json();

          if (json.success) {
            localStorage.setItem(
              "lifetimeUploadCount",
              parseInt(localStorage.getItem("lifetimeUploadCount") || 0) + 1
            );

            const item = processDriveData({
              id: json.data.fileId,
              name: json.data.name,
              mimeType: json.data.mimeType,
              webViewLink: json.data.webViewLink || json.data.driveLink,
              thumbnailLink: json.data.thumbnailLink,
            });

            saveHistory(item);
            renderItem(item);

            urlInput.value = "";
            showToast("Upload thành công!", "success");
            lastDataSignature = null;
          } else {
            showToast(
              "Lỗi Server: " + (json.message || "Không thể upload"),
              "error"
            );
          }
        } catch (error) {
          console.error(error);
          showToast("Lỗi kết nối Server!", "error");
        } finally {
          loadingBox.style.display = "none";
          loadStats(true);
        }
      }

      function exportHistory() {
        const historyData = localStorage.getItem("uploadHistory");
        if (!historyData) {
          showToast("Chưa có lịch sử để sao lưu!", "error");
          return;
        }
        const blob = new Blob([historyData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `upload_history_backup_${new Date()
          .toISOString()
          .slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("Đã tải xuống file backup!", "success");
      }

      async function handleFiles(files) {
        if (files.length === 0) return;
        loadingBox.style.display = "flex";
        let successCount = 0;
        updateLoadingText(0, files.length);
        const currentServerIndex = serverSelect.value || 0;

        const uploadPromises = files.map(async (file, index) => {
          const formData = new FormData();
          formData.append("myFile", file);
          formData.append("accountIndex", currentServerIndex);

          try {
            const res = await fetch(`${API_URL}/upload`, {
              method: "POST",
              body: formData,
            });
            const json = await res.json();
            updateLoadingText(index + 1, files.length);

            if (json.success) {
              successCount++;
              localStorage.setItem(
                "lifetimeUploadCount",
                parseInt(localStorage.getItem("lifetimeUploadCount") || 0) + 1
              );

              const d = json.data;

              const item = processDriveData({
                id: d.fileId,
                name: d.name,
                mimeType: d.mimeType,
                webViewLink: d.webViewLink || d.driveLink,
                thumbnailLink: d.thumbnailLink,
              });

              saveHistory(item);
              renderItem(item);
              return true;
            } else return false;
          } catch (e) {
            console.error(e);
            return false;
          }
        });

        await Promise.all(uploadPromises);
        loadingBox.style.display = "none";
        loadStats(true);
        lastDataSignature = null;

        if (successCount > 0)
          showToast(`Hoàn tất ${successCount} file!`, "success");
        else showToast("Lỗi upload!", "error");
      }

      function updateLoadingText(current, total) {
        const t = loadingBox.querySelector("p");
        if (t) t.innerText = `ĐANG XỬ LÝ... (${current}/${total})`;
      }

      dropZone.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", async (e) => {
        await handleFiles(Array.from(e.target.files));
        fileInput.value = "";
      });
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "var(--primary-color)";
        dropZone.style.transform = "scale(1.02)";
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.style.borderColor = "";
        dropZone.style.transform = "";
      });
      dropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "";
        dropZone.style.transform = "";
        await handleFiles(Array.from(e.dataTransfer.files));
      });

      async function emptyDriveTrash() {
        const serverIndex =
          document.getElementById("adminServerSelect").value || 0;
        const serverName =
          adminServerSelect.options[adminServerSelect.selectedIndex].text;

        if (
          !confirm(
            `Bạn có chắc chắn muốn XÓA VĨNH VIỄN tất cả file trong THÙNG RÁC của ${serverName}? Hành động này không thể hoàn tác!`
          )
        ) {
          return;
        }

        showToast("Đang dọn dẹp thùng rác...", "success");

        try {
          const res = await fetch(
            `${API_URL}/admin/empty-trash/${serverIndex}`,
            {
              method: "POST",
              headers: { "x-admin-pass": currentAdminToken },
            }
          );
          const data = await res.json();

          if (data.success) {
            showToast(`Đã dọn sạch thùng rác của ${serverName}!`, "success");

            loadAdminData();
          } else {
            showToast("Lỗi: " + data.error, "error");
          }
        } catch (error) {
          showToast("Lỗi kết nối server", "error");
        }
      }

      async function renameFile(fileId, currentName) {
        const newName = prompt("Nhập tên mới cho file:", currentName);

        if (
          newName === null ||
          newName.trim() === "" ||
          newName === currentName
        )
          return;

        const serverIndex =
          document.getElementById("adminServerSelect").value || 0;

        showToast("Đang đổi tên trên Drive...", "info");

        try {
          const res = await fetch(`${API_URL}/admin/rename`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-pass": currentAdminToken,
            },
            body: JSON.stringify({
              fileId: fileId,
              newName: newName.trim(),
              accountIndex: serverIndex,
            }),
          });

          const data = await res.json();

          if (data.success) {
            showToast("Đổi tên thành công!", "success");

            const file = adminFilesCache.find((f) => f.id === fileId);
            if (file) file.name = newName.trim();

            const row = document.getElementById(`row-${fileId}`);
            if (row) {
              const nameSpan = row.querySelector(".admin-file-link");
              if (nameSpan)
                nameSpan.innerHTML = `<i class="fa-solid fa-eye"></i> ${newName.trim()}`;

              const editBtn = row.querySelectorAll("button")[0];
              editBtn.setAttribute(
                "onclick",
                `renameFile('${fileId}', '${newName
                  .trim()
                  .replace(/'/g, "\\'")}')`
              );
            }
          } else {
            showToast("Lỗi: " + data.message, "error");
          }
        } catch (e) {
          console.error(e);
          showToast("Lỗi kết nối Server", "error");
        }
      }

      (function () {
        const URL_ANH =
          "https://cdn.pixabay.com/animation/2024/04/25/19/52/19-52-51-662_512.gif";
        const KICH_THUOC = 110;
        const MAX_TOC_DO = 1.5;
        const DO_NGHIENG_MAX = 25;
        const DO_MUOT_XOAY = 0.02;

        const bee = document.createElement("img");
        bee.src = URL_ANH;

        Object.assign(bee.style, {
          position: "fixed",
          width: KICH_THUOC + "px",
          height: "auto",
          zIndex: "999999",
          pointerEvents: "none",
          left: "0px",
          top: "0px",
          willChange: "transform",
          transition: "none",
        });

        document.body.appendChild(bee);

        let x = window.innerWidth / 2;
        let y = window.innerHeight / 2;

        let vx = 0;
        let vy = 0;

        let currentAngle = 0;
        let facing = 1;

        function animate() {
          vx += (Math.random() - 0.5) * 0.4;
          vy += (Math.random() - 0.5) * 0.4;

          const speed = Math.sqrt(vx * vx + vy * vy);
          if (speed > MAX_TOC_DO) {
            vx = (vx / speed) * MAX_TOC_DO;
            vy = (vy / speed) * MAX_TOC_DO;
          }

          x += vx;
          y += vy;

          const margin = 50;
          if (x < margin) vx += 0.15;
          if (x > window.innerWidth - margin - KICH_THUOC) vx -= 0.15;
          if (y < margin) vy += 0.15;
          if (y > window.innerHeight - margin - KICH_THUOC) vy -= 0.15;

          if (Math.abs(vx) > 0.2) {
            facing = vx < 0 ? 1 : -1;
          }

          let targetAngle = vy * 8;

          if (targetAngle > DO_NGHIENG_MAX) targetAngle = DO_NGHIENG_MAX;
          if (targetAngle < -DO_NGHIENG_MAX) targetAngle = -DO_NGHIENG_MAX;

          if (facing === -1) targetAngle = -targetAngle;

          currentAngle += (targetAngle - currentAngle) * DO_MUOT_XOAY;

          bee.style.transform = `translate(${x}px, ${y}px) scaleX(${facing}) rotate(${currentAngle}deg)`;

          requestAnimationFrame(animate);
        }

        animate();
      })();
    </script>
  </body>
</html>
